{% extends "base.html" %}

{% block title %}Leave Requests{% endblock %}

{% block content %}
<div class="mb-8 page-content">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-semibold text-gray-900">Leave Requests</h1>
            <p class="text-gray-600 mt-1">{% if user_role == 'admin' %}Manage employee leave applications{% else %}View and submit leave requests{% endif %}</p>
        </div>
        {% if user_role == 'employee' %}
        <a href="{{ url_for('add_leave_request') }}" class="btn btn-primary">
            + Request Leave
        </a>
        {% endif %}
    </div>
</div>

<!-- Filter Tabs -->
<div class="bg-white rounded-lg shadow mb-6 card-animate">
    <div class="border-b border-gray-200">
        <nav class="flex -mb-px">
            <a href="{{ url_for('leave_requests') }}" 
               class="py-4 px-6 text-sm font-medium {% if not status_filter %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                All Requests
            </a>
            <a href="{{ url_for('leave_requests', status='Pending') }}" 
               class="py-4 px-6 text-sm font-medium {% if status_filter == 'Pending' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                Pending
            </a>
            <a href="{{ url_for('leave_requests', status='Approved') }}" 
               class="py-4 px-6 text-sm font-medium {% if status_filter == 'Approved' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                Approved
            </a>
            <a href="{{ url_for('leave_requests', status='Rejected') }}" 
               class="py-4 px-6 text-sm font-medium {% if status_filter == 'Rejected' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                Rejected
            </a>
        </nav>
    </div>
</div>

<!-- Leave Requests List -->
<div class="space-y-4">
    {% if leaves %}
        {% for leave in leave_requests %}
        <div class="bg-white rounded-lg shadow p-6 mb-4 cursor-pointer hover:shadow-lg transition-shadow" onclick="window.location='{{ url_for('view_leave_request', leave_id=leave.leave_id) }}'">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h3 class="text-lg font-semibold text-gray-900">{{ leave.employee.name }}</h3>
                        <span class="status-badge status-{{ leave.status.lower() }}">{{ leave.status }}</span>
                        <i class="fas fa-arrow-right text-gray-400 ml-auto"></i>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <p class="text-sm text-gray-500">Leave Type</p>
                            <p class="font-medium text-gray-900">{{ leave.leave_type }}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Duration</p>
                            <p class="font-medium text-gray-900">
                                {{ leave.start_date.strftime('%b %d') }} - {{ leave.end_date.strftime('%b %d, %Y') }}
                            </p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Days</p>
                            <p class="font-medium text-gray-900">{{ leave.calculate_days() }} day(s)</p>
                        </div>
                    </div>
                    
                    {% if leave.reason %}
                    <div class="mb-3">
                        <p class="text-sm text-gray-500">Reason</p>
                        <p class="text-sm text-gray-700">{{ leave.reason }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="text-xs text-gray-500">
                        <span>Submitted: {{ leave.submitted_at.strftime('%b %d, %Y at %I:%M %p') if leave.submitted_at else 'N/A' }}</span>
                        {% if leave.reviewed_at %}
                        <span class="ml-4">Reviewed: {{ leave.reviewed_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if user_role == 'admin' and leave.is_pending() %}
                <div class="mt-3 ml-4">
                    <button type="button" class="btn btn-sm btn-primary" 
                            data-bs-toggle="modal" 
                            data-bs-target="#leaveModal{{ leave.leave_id }}">
                        <i class="fas fa-edit me-1"></i>Review
                    </button>
                </div>

                <!-- Leave Review Modal -->
                <div class="modal fade" id="leaveModal{{ leave.leave_id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('update_leave_request', leave_id=leave.leave_id) }}">
                                <div class="modal-header">
                                    <h5 class="modal-title">Review Leave Request</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>Employee:</strong> {{ leave.employee.name }}<br>
                                        <strong>Type:</strong> {{ leave.leave_type }}<br>
                                        <strong>Duration:</strong> {{ leave.start_date.strftime('%Y-%m-%d') }} to {{ leave.end_date.strftime('%Y-%m-%d') }} ({{ leave.calculate_days() }} days)<br>
                                        <strong>Reason:</strong> {{ leave.reason or 'No reason provided' }}
                                    </div>
                                    <hr>
                                    <div class="mb-3">
                                        <label for="hr_notes_{{ leave.leave_id }}" class="form-label">
                                            <strong>HR Notes</strong> <small class="text-muted">(Optional - will be visible to employee)</small>
                                        </label>
                                        <textarea class="form-control" 
                                                  id="hr_notes_{{ leave.leave_id }}" 
                                                  name="hr_notes" 
                                                  rows="4" 
                                                  placeholder="Add notes about your decision (e.g., approved with conditions, rejection reason, etc.)"></textarea>
                                    </div>
                                    <input type="hidden" id="action_{{ leave.leave_id }}" name="action" value="">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-danger" 
                                            onclick="document.getElementById('action_{{ leave.leave_id }}').value='reject'">
                                        <i class="fas fa-times me-1"></i>Reject
                                    </button>
                                    <button type="submit" class="btn btn-success" 
                                            onclick="document.getElementById('action_{{ leave.leave_id }}').value='approve'">
                                        <i class="fas fa-check me-1"></i>Approve
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="bg-white rounded-lg shadow p-12 text-center">
        <p class="text-gray-500">
            {% if status_filter %}
                No {{ status_filter.lower() }} leave requests found.
            {% else %}
                No leave requests found.
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}

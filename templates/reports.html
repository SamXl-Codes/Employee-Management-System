{% extends "base.html" %}

{% block title %}Advanced Reports{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-semibold text-gray-900">Advanced Reports & Analytics</h1>
    <p class="text-gray-600 mt-1">Generate detailed reports with filters and visualizations</p>
</div>

<!-- Report Type Selection -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="border-b border-gray-200">
        <nav class="flex -mb-px">
            <a href="{{ url_for('reports', type='overview') }}" 
               class="py-4 px-6 text-sm font-medium {% if report_type == 'overview' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                Overview & Exports
            </a>
            <a href="{{ url_for('reports', type='attendance_summary') }}" 
               class="py-4 px-6 text-sm font-medium {% if report_type == 'attendance_summary' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                Attendance Summary
            </a>
            <a href="{{ url_for('reports', type='leave_summary') }}" 
               class="py-4 px-6 text-sm font-medium {% if report_type == 'leave_summary' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                Leave Summary
            </a>
            <a href="{{ url_for('reports', type='payroll_summary') }}" 
               class="py-4 px-6 text-sm font-medium {% if report_type == 'payroll_summary' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700{% endif %}">
                Payroll Summary
            </a>
        </nav>
    </div>
</div>

{% if report_type != 'overview' %}
<!-- Filters -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filters</h3>
    <form method="GET" action="{{ url_for('reports') }}" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input type="hidden" name="type" value="{{ report_type }}">
        
        {% if report_type in ['attendance_summary', 'leave_summary'] %}
        <div>
            <label class="form-label">Start Date</label>
            <input type="date" 
                   name="start_date" 
                   value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}"
                   class="form-input">
        </div>
        
        <div>
            <label class="form-label">End Date</label>
            <input type="date" 
                   name="end_date" 
                   value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}"
                   class="form-input">
        </div>
        {% endif %}
        
        <div>
            <label class="form-label">Department</label>
            <select name="department_id" class="form-input">
                <option value="">All Departments</option>
                {% for dept in departments %}
                <option value="{{ dept.department_id }}" {% if selected_department == dept.department_id|string %}selected{% endif %}>
                    {{ dept.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="flex items-end">
            <button type="submit" class="btn btn-primary w-full">Apply Filters</button>
        </div>
    </form>
</div>
{% endif %}

<!-- Report Content -->
{% if report_type == 'overview' %}
    <!-- Keep existing overview/exports content -->
    {{ exports_section() }}
    
{% elif report_type == 'attendance_summary' and report_data %}
    {% if chart_data and chart_data.get('attendance_chart') %}
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="h-96">
            <canvas id="attendanceChart"></canvas>
        </div>
    </div>
    {% endif %}
    
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Attendance Summary Report</h3>
            <p class="text-sm text-gray-600 mt-1">{{ report_data|length }} employees</p>
        </div>
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Total Days</th>
                        <th>Present</th>
                        <th>Absent</th>
                        <th>Late</th>
                        <th>Attendance %</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in report_data %}
                    <tr>
                        <td class="font-medium text-gray-900">{{ row.employee.name }}</td>
                        <td>{{ row.employee.department.name if row.employee.department else 'N/A' }}</td>
                        <td class="text-center">{{ row.total_days }}</td>
                        <td class="text-center text-green-600 font-medium">{{ row.present_days }}</td>
                        <td class="text-center text-red-600 font-medium">{{ row.absent_days }}</td>
                        <td class="text-center text-yellow-600 font-medium">{{ row.late_days }}</td>
                        <td class="text-center">
                            <span class="font-medium {% if row.attendance_percentage >= 90 %}text-green-600{% elif row.attendance_percentage >= 75 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                {{ row.attendance_percentage }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

{% elif report_type == 'leave_summary' and report_data %}
    {% if chart_data and chart_data.get('leave_chart') %}
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="h-80 flex justify-center">
            <div class="w-96">
                <canvas id="leaveChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Leave Summary Report</h3>
            <p class="text-sm text-gray-600 mt-1">{{ report_data|length }} employees</p>
        </div>
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Total Requests</th>
                        <th>Approved</th>
                        <th>Pending</th>
                        <th>Rejected</th>
                        <th>Total Leave Days</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in report_data %}
                    <tr>
                        <td class="font-medium text-gray-900">{{ row.employee.name }}</td>
                        <td>{{ row.employee.department.name if row.employee.department else 'N/A' }}</td>
                        <td class="text-center">{{ row.total_requests }}</td>
                        <td class="text-center text-green-600 font-medium">{{ row.approved_requests }}</td>
                        <td class="text-center text-yellow-600 font-medium">{{ row.pending_requests }}</td>
                        <td class="text-center text-red-600 font-medium">{{ row.rejected_requests }}</td>
                        <td class="text-center font-medium">{{ row.total_leave_days }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

{% elif report_type == 'payroll_summary' and report_data %}
    {% if chart_data and chart_data.get('payroll_chart') %}
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="h-80 flex justify-center">
            <div class="w-96">
                <canvas id="payrollChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Payroll Summary</h3>
            <p class="text-sm text-gray-600 mt-1">{{ report_data.employees|length }} employees</p>
        </div>
        
        <!-- Totals -->
        <div class="px-6 py-4 bg-blue-50 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <p class="text-sm text-gray-600">Total Annual Payroll</p>
                <p class="text-2xl font-bold text-gray-900">${{ "{:,.2f}".format(report_data.total_annual_payroll) }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Total Monthly Payroll</p>
                <p class="text-2xl font-bold text-gray-900">${{ "{:,.2f}".format(report_data.total_monthly_payroll) }}</p>
            </div>
        </div>
        
        <!-- Employee Details -->
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Role</th>
                        <th>Annual Salary</th>
                        <th>Monthly Salary</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in report_data.employees %}
                    <tr>
                        <td class="font-medium text-gray-900">{{ row.employee.name }}</td>
                        <td>{{ row.employee.department.name if row.employee.department else 'N/A' }}</td>
                        <td>{{ row.employee.role.title if row.employee.role else 'N/A' }}</td>
                        <td class="font-mono">${{ "{:,.2f}".format(row.annual_salary) }}</td>
                        <td class="font-mono">${{ "{:,.2f}".format(row.monthly_salary) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // Chart.js initialization
    {% if chart_data %}
        {% if chart_data.get('attendance_chart') %}
            const attendanceData = {{ chart_data.get('attendance_chart')|safe }};
            const attendanceCtx = document.getElementById('attendanceChart');
            if (attendanceCtx) {
                new Chart(attendanceCtx, {
                    type: attendanceData.type,
                    data: {
                        labels: attendanceData.labels,
                        datasets: [{
                            label: 'Attendance %',
                            data: attendanceData.data,
                            backgroundColor: attendanceData.colors,
                            borderRadius: 5,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: function(ctx) { return ctx.parsed.y.toFixed(1) + '%'; } } }
                        },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            }
        {% endif %}
        
        {% if chart_data.get('leave_chart') %}
            const leaveData = {{ chart_data.get('leave_chart')|safe }};
            const leaveCtx = document.getElementById('leaveChart');
            if (leaveCtx) {
                new Chart(leaveCtx, {
                    type: leaveData.type,
                    data: {
                        labels: leaveData.labels,
                        datasets: [{
                            data: leaveData.data,
                            backgroundColor: leaveData.colors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
        {% endif %}
        
        {% if chart_data.get('payroll_chart') %}
            const payrollData = {{ chart_data.get('payroll_chart')|safe }};
            const payrollCtx = document.getElementById('payrollChart');
            if (payrollCtx) {
                new Chart(payrollCtx, {
                    type: payrollData.type,
                    data: {
                        labels: payrollData.labels,
                        datasets: [{
                            data: payrollData.data,
                            backgroundColor: payrollData.colors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
        {% endif %}
    {% endif %}
</script>
{% endblock %}

{% macro exports_section() %}
<!-- Existing exports grid from reports.html -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center gap-3 mb-4">
            <div class="bg-blue-100 rounded-full p-3">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
            </div>
            <h2 class="text-xl font-semibold text-gray-900">Employee Report</h2>
        </div>
        <p class="text-sm text-gray-600 mb-6">Complete list of all employees with their details including department, role, salary, and status.</p>
        <div class="flex gap-3">
            <a href="{{ url_for('export_employees_csv') }}" class="btn btn-primary flex-1">Download CSV</a>
            <a href="{{ url_for('export_employees_json') }}" class="btn btn-secondary flex-1">Download JSON</a>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center gap-3 mb-4">
            <div class="bg-yellow-100 rounded-full p-3">
                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
            </div>
            <h2 class="text-xl font-semibold text-gray-900">Leave Summary</h2>
        </div>
        <p class="text-sm text-gray-600 mb-6">Summary of leave days used by each employee, including pending and approved requests.</p>
        <div class="flex gap-3">
            <a href="{{ url_for('export_leave_summary_csv') }}" class="btn btn-primary flex-1">Download CSV</a>
        </div>
    </div>
</div>

<!-- API Information -->
<div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
    <h3 class="text-lg font-semibold text-blue-900 mb-3">REST API Endpoints</h3>
    <p class="text-sm text-blue-800 mb-4">Access employee data programmatically via our REST API:</p>
    <div class="space-y-2 font-mono text-sm">
        <div class="bg-white rounded p-3">
            <span class="text-green-600 font-semibold">GET</span>
            <span class="ml-3 text-gray-700">/api/employees</span>
            <span class="ml-3 text-gray-500">- Get all employees as JSON</span>
        </div>
        <div class="bg-white rounded p-3">
            <span class="text-green-600 font-semibold">GET</span>
            <span class="ml-3 text-gray-700">/api/stats</span>
            <span class="ml-3 text-gray-500">- Get dashboard statistics</span>
        </div>
    </div>
</div>
{% endmacro %}
{% endblock %}

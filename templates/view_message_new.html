{% extends "base.html" %}

{% block title %}{{ message.subject }} - WorkflowX{% endblock %}

{% block content %}
<style>
    .message-view-container {
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
        background: #f5f5f5;
        padding: 20px;
    }
    
    [data-theme="dark"] .message-view-container {
        background: #1a1a1a;
    }
    
    .message-header-bar {
        background: white;
        padding: 20px 30px;
        border-radius: 12px 12px 0 0;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    [data-theme="dark"] .message-header-bar {
        background: #2a2a2a;
        border-color: #404040;
    }
    
    .message-thread-container {
        flex: 1;
        background: white;
        overflow-y: auto;
        padding: 30px;
    }
    
    [data-theme="dark"] .message-thread-container {
        background: #2a2a2a;
    }
    
    .message-bubble-wrapper {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message-bubble-wrapper.sent {
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        flex-shrink: 0;
    }
    
    .message-avatar img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e0e0e0;
    }
    
    [data-theme="dark"] .message-avatar img {
        border-color: #404040;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 16px 20px;
        border-radius: 18px;
        position: relative;
    }
    
    .message-bubble.received {
        background: #f0f0f0;
        color: #333;
        border-bottom-left-radius: 4px;
    }
    
    [data-theme="dark"] .message-bubble.received {
        background: #333;
        color: #e0e0e0;
    }
    
    .message-bubble.sent {
        background: #2563eb;
        color: white;
        border-bottom-right-radius: 4px;
        margin-left: auto;
    }
    
    .message-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        gap: 15px;
    }
    
    .message-sender {
        font-weight: 600;
        font-size: 14px;
    }
    
    .message-time {
        font-size: 12px;
        opacity: 0.7;
    }
    
    .message-text {
        white-space: pre-wrap;
        line-height: 1.5;
        font-size: 14px;
    }
    
    .reply-box {
        background: white;
        padding: 20px 30px;
        border-radius: 0 0 12px 12px;
        border-top: 1px solid #e0e0e0;
    }
    
    [data-theme="dark"] .reply-box {
        background: #2a2a2a;
        border-color: #404040;
    }
    
    .reply-input-wrapper {
        display: flex;
        gap: 15px;
        align-items: flex-end;
    }
    
    .reply-input {
        flex: 1;
        border: 1px solid #e0e0e0;
        border-radius: 24px;
        padding: 12px 20px;
        resize: none;
        outline: none;
        font-family: inherit;
        font-size: 14px;
        max-height: 120px;
        background: #f8f8f8;
    }
    
    [data-theme="dark"] .reply-input {
        background: #333;
        border-color: #404040;
        color: #e0e0e0;
    }
    
    .reply-input:focus {
        border-color: #2563eb;
        background: white;
    }
    
    [data-theme="dark"] .reply-input:focus {
        background: #2a2a2a;
        border-color: #3b82f6;
    }
    
    .send-button {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: #2563eb;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    
    .send-button:hover {
        background: #1d4ed8;
        transform: scale(1.05);
    }
    
    .send-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: scale(1);
    }
    
    .back-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: transparent;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        color: #666;
        text-decoration: none;
        transition: all 0.2s;
    }
    
    [data-theme="dark"] .back-button {
        border-color: #404040;
        color: #999;
    }
    
    .back-button:hover {
        background: #f0f0f0;
        color: #333;
    }
    
    [data-theme="dark"] .back-button:hover {
        background: #333;
        color: #e0e0e0;
    }
</style>

<div class="message-view-container">
    <!-- Header -->
    <div class="message-header-bar">
        <div>
            <a href="{{ url_for('employee_messages') }}" class="back-button">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back to Messages
            </a>
        </div>
        <div>
            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200">{{ message.subject }}</h4>
        </div>
        <div style="width: 150px;"></div> <!-- Spacer for centering -->
    </div>
    
    <!-- Message Thread -->
    <div class="message-thread-container">
        {% for msg in conversation %}
        <div class="message-bubble-wrapper {% if msg.sender_id == session.user_id %}sent{% else %}received{% endif %}">
            <!-- Avatar -->
            <div class="message-avatar">
                {% set sender_employee = msg.sender.employees|first if msg.sender and msg.sender.employees else None %}
                {% if sender_employee and sender_employee.profile_image %}
                    <img src="{{ url_for('static', filename='images/profiles/' + sender_employee.profile_image) }}" 
                         alt="{{ msg.sender.username }}"
                         onerror="this.onerror=null; this.outerHTML='<div style=\'width:48px;height:48px;border-radius:50%;background:#2563eb;color:white;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:18px;\'>{{ msg.sender.username[0].upper() if msg.sender else \'A\' }}</div>';">
                {% else %}
                    <div style="width:48px;height:48px;border-radius:50%;background:{% if msg.sender_id == session.user_id %}#2563eb{% else %}#10b981{% endif %};color:white;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:18px;border:2px solid #e0e0e0;">
                        {{ msg.sender.username[0].upper() if msg.sender else 'A' }}
                    </div>
                {% endif %}
            </div>
            
            <!-- Message Bubble -->
            <div class="message-bubble {% if msg.sender_id == session.user_id %}sent{% else %}received{% endif %}">
                <div class="message-meta">
                    <span class="message-sender">
                        {{ msg.sender.username if msg.sender else 'Admin' }}
                    </span>
                    <span class="message-time">
                        {{ msg.sent_at.strftime('%b %d, %I:%M %p') if msg.sent_at else 'N/A' }}
                    </span>
                </div>
                <div class="message-text">{{ msg.body }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Reply Box -->
    <div class="reply-box">
        <form method="POST" action="{{ url_for('employee_send_message') }}" id="replyForm">
            <input type="hidden" name="recipient_id" value="{{ message.sender_id }}">
            <input type="hidden" name="subject" value="Re: {{ message.subject }}">
            
            <div class="reply-input-wrapper">
                <textarea class="reply-input" 
                          name="body" 
                          id="replyText"
                          placeholder="Type your reply..."
                          required
                          rows="2"></textarea>
                <button type="submit" class="send-button" id="sendBtn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Auto-expand textarea
    const textarea = document.getElementById('replyText');
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Scroll to bottom on load
    const container = document.querySelector('.message-thread-container');
    container.scrollTop = container.scrollHeight;
    
    // Enable/disable send button based on input
    textarea.addEventListener('input', function() {
        document.getElementById('sendBtn').disabled = !this.value.trim();
    });
</script>
{% endblock %}

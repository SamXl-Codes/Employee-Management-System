{% extends "base.html" %}

{% block title %}QR Code Check-In - WorkFlowX{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <div class="mb-8 text-center">
            <div class="flex items-center justify-center gap-3 mb-3">
                <svg class="w-10 h-10 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                </svg>
                <h1 class="text-4xl font-bold text-black dark:text-white" style="color: #000000;">
                    Daily Attendance QR Code
                </h1>
            </div>
            <p class="text-xl font-semibold text-black dark:text-gray-100 mb-3" style="color: #000000;">
                Display this QR code for employees to scan when arriving at work
            </p>
            <div class="inline-flex items-center gap-2 bg-blue-600 dark:bg-blue-700 px-5 py-2 rounded-lg shadow-md">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <p class="text-sm font-bold text-white">
                    Valid for: <span id="current-date">{{ today }}</span>
                </p>
            </div>
            <div class="mt-2 text-center">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    Current time: <span id="current-time" class="font-mono font-semibold"></span>
                </p>
            </div>
        </div>

        <!-- QR Code Display Card -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 mb-6">
            <div class="text-center">
                <!-- QR Code Image -->
                <div class="bg-white p-8 rounded-lg inline-block mb-6">
                    <img src="data:image/png;base64,{{ qr_code }}" 
                         alt="Check-in QR Code"
                         class="w-80 h-80 mx-auto">
                </div>

                <!-- Instructions -->
                <div class="space-y-4 text-left max-w-md mx-auto">
                    <div class="flex items-center justify-center gap-2 mb-4">
                        <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                            How to Use
                        </h3>
                    </div>
                    
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 font-bold">
                            1
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 pt-1">
                            <strong>Display on tablet/monitor</strong> at the office entrance or reception desk
                        </p>
                    </div>

                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 font-bold">
                            2
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 pt-1">
                            <strong>Employees scan</strong> with their smartphone camera or QR scanner app
                        </p>
                    </div>

                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 font-bold">
                            3
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 pt-1">
                            <strong>Automatic check-in</strong> - System records attendance with timestamp
                        </p>
                    </div>

                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 font-bold">
                            4
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 pt-1">
                            <strong>Status determined</strong> - Present (up to 9:19 AM), Late (9:20 AM onwards)
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Info Card -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border-l-4 border-blue-500">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Quick Guide</h4>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-start gap-2">
                            <span class="text-blue-600 dark:text-blue-400 font-bold">•</span>
                            <p class="text-gray-900 dark:text-gray-100">
                                <strong>Valid Today:</strong> This QR code works for {{ today }} only and will refresh automatically at midnight
                            </p>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-blue-600 dark:text-blue-400 font-bold">•</span>
                            <p class="text-gray-900 dark:text-gray-100">
                                <strong>One Check-In:</strong> Employees can scan once per day. System prevents duplicate entries
                            </p>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-blue-600 dark:text-blue-400 font-bold">•</span>
                            <p class="text-gray-900 dark:text-gray-100">
                                <strong>Login Required:</strong> Employees must be signed in to their account before scanning
                            </p>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-blue-600 dark:text-blue-400 font-bold">•</span>
                            <p class="text-gray-900 dark:text-gray-100">
                                <strong>Time Rules:</strong> Present status for check-in up to 9:19 AM. Late status starts at 9:20 AM
                            </p>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-blue-600 dark:text-blue-400 font-bold">•</span>
                            <p class="text-gray-900 dark:text-gray-100">
                                <strong>Manual Override:</strong> HR can adjust attendance records manually from the Attendance page if needed
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 flex gap-4 justify-center">
            <a href="{{ url_for('attendance') }}" class="btn btn-secondary">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                View Attendance Records
            </a>
            
            <button onclick="window.print()" class="btn btn-primary">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                </svg>
                Print QR Code
            </button>

            <button onclick="copyUrl()" class="btn btn-secondary">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                Copy Link
            </button>
        </div>

        <!-- Hidden URL for copying -->
        <input type="hidden" id="checkinUrl" value="{{ checkin_url }}">
    </div>
</div>

<script>
function copyUrl() {
    const urlInput = document.getElementById('checkinUrl');
    urlInput.type = 'text';
    urlInput.select();
    document.execCommand('copy');
    urlInput.type = 'hidden';
    
    // Show feedback
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>Copied!';
    btn.classList.add('bg-green-600');
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('bg-green-600');
    }, 2000);
}

// Update date and time display dynamically
function updateDateTime() {
    // Get current date and time
    const now = new Date();
    
    // Update time display (HH:MM:SS AM/PM)
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: true 
    });
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
        timeElement.textContent = timeStr;
    }
    
    // Check if date changed (midnight passed)
    const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD format
    const dateElement = document.getElementById('current-date');
    if (dateElement) {
        const currentDisplayedDate = dateElement.textContent.trim();
        if (dateStr !== currentDisplayedDate) {
            // Date changed! Reload page to get new QR token for new day
            console.log('Date changed from', currentDisplayedDate, 'to', dateStr, '- reloading page');
            location.reload();
        }
    }
}

// Initialize date/time display
updateDateTime();

// Update every second for live clock
setInterval(updateDateTime, 1000);

// Backup: Auto-refresh QR code at midnight (in case the date check above doesn't trigger)
const now = new Date();
const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
const timeUntilMidnight = tomorrow - now;

setTimeout(() => {
    location.reload();
}, timeUntilMidnight);
</script>

<style>
@media print {
    .navbar, .btn, nav, footer {
        display: none !important;
    }
    .container {
        max-width: 100%;
    }
    body {
        background: white !important;
    }
}
</style>
{% endblock %}
